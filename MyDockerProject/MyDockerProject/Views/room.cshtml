@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage
@using Umbraco.Cms.Core.Models.PublishedContent
@{
    // Choose layout: Main, HolyGrail, Sidebar, Centered, FullWidth
    Layout = ViewData["Layout"] as string ?? "Layouts/Main.cshtml";
    ViewData["Title"] = Model?.Name ?? "Room Details";
    ViewData["SiteName"] = "Hotel Booking Site";
    
    // Get IDs from Model (Umbraco) or route/ViewBag (custom route)
    var roomId = Model?.Key.ToString() ?? ViewBag.RoomId as string ?? Context.Request.RouteValues["roomId"]?.ToString();
    
    // For hotel ID, try parent (if Room is child of Hotel) or route
    var hotelId = (Model?.Parent as IPublishedContent)?.Key.ToString() 
                  ?? ViewBag.HotelId as string 
                  ?? Context.Request.RouteValues["hotelId"]?.ToString();
}

<div id="room-page-content">
    <div class="text-center py-12">
        <p class="text-gray-600">Loading room details...</p>
    </div>
</div>

<script>
    const hotelId = '@hotelId';
    const roomId = '@roomId';
    
    Promise.all([
        fetch(`/api/hotels/${hotelId}`).then(r => r.json()),
        fetch(`/api/hotels/${hotelId}/rooms`).then(r => r.json())
    ])
    .then(([hotel, rooms]) => {
        const room = rooms.find(r => r.id === roomId);
        const container = document.getElementById('room-page-content');
        
        if (!room) {
            container.innerHTML = `
                <div class="text-center py-12">
                    <h1 class="text-3xl font-bold mb-4">Room Not Found</h1>
                    <a href="/hotels/${hotelId}" class="text-blue-600 hover:underline">← Back to Hotel</a>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        // Back link
        html += `
            <div class="container mx-auto px-4 py-4">
                <a href="/hotels/${hotelId}" class="text-blue-600 hover:underline">← Back to ${hotel.name || 'Hotel'}</a>
            </div>
        `;
        
        // Hero Section for Room
        html += `
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-16">
                <div class="container mx-auto px-4">
                    <h1 class="text-4xl font-bold mb-4">${room.name || 'Room'}</h1>
                    ${room.description ? `<p class="text-xl opacity-90 mb-6">${room.description}</p>` : ''}
                </div>
            </div>
        `;
        
        // Room Details Section
        html += `
            <section class="py-12">
                <div class="container mx-auto px-4">
                    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            ${room.priceFrom ? `
                                <div class="text-center">
                                    <p class="text-sm text-gray-500 mb-2">Price from</p>
                                    <p class="text-3xl font-bold text-blue-600">£${room.priceFrom} <span class="text-lg">per night</span></p>
                                </div>
                            ` : ''}
                            ${room.maxOccupancy ? `
                                <div class="text-center">
                                    <p class="text-sm text-gray-500 mb-2">Max Occupancy</p>
                                    <p class="text-2xl font-bold">${room.maxOccupancy} <span class="text-lg text-gray-500">guests</span></p>
                                </div>
                            ` : ''}
                            ${room.roomType ? `
                                <div class="text-center">
                                    <p class="text-sm text-gray-500 mb-2">Room Type</p>
                                    <p class="text-xl font-semibold">${room.roomType}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </section>
        `;
        
        // Booking Engine Section
        html += `
            <section class="py-12 bg-gray-50">
                <div class="container mx-auto px-4">
                    <h2 class="text-3xl font-bold mb-8 text-center">Book This Room</h2>
                    <div id="booking-engine-root" 
                         data-product-id="${roomId}"
                         data-hotel-id="${hotelId}"
                         data-api-base-url="/engine"
                         class="max-w-4xl mx-auto">
                        <div class="text-center py-12 bg-white rounded-lg shadow-md">
                            <p class="text-gray-600">Loading booking engine...</p>
                        </div>
                    </div>
                </div>
            </section>
        `;
        
        container.innerHTML = html;
        
        // Load React Booking Engine
        const script = document.createElement('script');
        script.src = 'http://localhost:5173/booking-engine.js';
        script.onload = () => {
            if (window.initBookingEngine) {
                window.initBookingEngine({
                    containerId: 'booking-engine-root',
                    productId: roomId,
                    hotelId: hotelId,
                    apiBaseUrl: '/engine'
                });
            }
        };
        script.onerror = () => {
            document.getElementById('booking-engine-root').innerHTML = `
                <div class="text-center py-12 bg-white rounded-lg shadow-md">
                    <p class="text-red-600 mb-4">Booking engine failed to load.</p>
                    <p class="text-sm text-gray-500">Make sure the React booking engine is running on port 5173</p>
                </div>
            `;
        };
        document.head.appendChild(script);
    })
    .catch(error => {
        console.error('Error loading room:', error);
        document.getElementById('room-page-content').innerHTML = `
            <div class="text-center py-12">
                <p class="text-red-600">Error loading room details. Please try again later.</p>
            </div>
        `;
    });
</script>
